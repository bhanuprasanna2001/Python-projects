# =============================================================================
# ETL Data Pipeline - Makefile for Development Tasks
# =============================================================================
# Usage:
#   make help       - Show available commands
#   make check      - Run all quality checks
#   make fix        - Auto-fix all fixable issues
#   make test       - Run tests with coverage
#   make run        - Run full ETL pipeline
#   make scheduler  - Start the pipeline scheduler
# =============================================================================

.PHONY: help install dev-install run extract transform load scheduler status \
        validate sources test test-cov lint format fix typecheck check clean \
        db-up db-down

# Default target
help:
	@echo ""
	@echo "ETL Data Pipeline - Development Commands"
	@echo "========================================="
	@echo ""
	@echo "Setup:"
	@echo "  make install       - Install dependencies"
	@echo "  make dev-install   - Install development dependencies"
	@echo ""
	@echo "Pipeline Execution:"
	@echo "  make run           - Run full ETL pipeline"
	@echo "  make extract       - Run extraction only"
	@echo "  make transform     - Run transformation only"
	@echo "  make load          - Run loading only"
	@echo "  make scheduler     - Start the scheduler"
	@echo "  make status        - Show pipeline status"
	@echo ""
	@echo "Utilities:"
	@echo "  make validate      - Validate configuration"
	@echo "  make sources       - List configured sources"
	@echo ""
	@echo "Database:"
	@echo "  make db-up         - Start PostgreSQL container"
	@echo "  make db-down       - Stop PostgreSQL container"
	@echo ""
	@echo "Quality Checks:"
	@echo "  make lint          - Run Ruff linter"
	@echo "  make format        - Check code formatting"
	@echo "  make typecheck     - Run mypy type checker"
	@echo "  make test          - Run tests"
	@echo "  make test-cov      - Run tests with coverage"
	@echo "  make check         - Run ALL quality checks"
	@echo ""
	@echo "Auto-Fix:"
	@echo "  make fix           - Auto-fix lint + format issues"
	@echo ""
	@echo "Cleanup:"
	@echo "  make clean         - Remove cache files"
	@echo ""

# =============================================================================
# Setup
# =============================================================================
install:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Installing dependencies"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	pip install -e .
	@echo "✓ Installation complete\n"

dev-install:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Installing development dependencies"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	pip install -e ".[dev]"
	@echo "✓ Development installation complete\n"

# =============================================================================
# Pipeline Execution
# =============================================================================
run:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running full ETL pipeline"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline run

extract:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running extraction stage"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline run --stage extract

transform:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running transformation stage"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline run --stage transform

load:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running loading stage"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline run --stage load

scheduler:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Starting pipeline scheduler"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline scheduler start

status:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Showing pipeline status"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline status

# =============================================================================
# Utilities
# =============================================================================
validate:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Validating configuration"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline validate

sources:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Listing configured sources"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m etl_pipeline sources

# =============================================================================
# Database Commands
# =============================================================================
db-up:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Starting PostgreSQL container"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	docker compose up -d db
	@echo "Waiting for PostgreSQL to be ready..."
	@sleep 3
	@echo "✓ PostgreSQL is running\n"

db-down:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Stopping PostgreSQL container"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	docker compose down
	@echo "✓ PostgreSQL stopped\n"

# =============================================================================
# Quality Checks
# =============================================================================
lint:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running Ruff linter"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m ruff check etl_pipeline tests
	@echo "✓ Linting passed\n"

format:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Checking code formatting"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m ruff format --check etl_pipeline tests
	@echo "✓ Formatting check passed\n"

typecheck:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running mypy type checker"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m mypy etl_pipeline
	@echo "✓ Type checking passed\n"

check: lint format typecheck test
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "✓ All quality checks passed!"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n"

# =============================================================================
# Auto-Fix
# =============================================================================
fix:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Auto-fixing lint issues"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m ruff check --fix etl_pipeline tests
	@echo ""
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Auto-formatting code"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m ruff format etl_pipeline tests
	@echo "✓ All fixes applied\n"

# =============================================================================
# Testing
# =============================================================================
test:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running tests"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m pytest tests/ -v
	@echo "✓ Tests complete\n"

test-cov:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Running tests with coverage"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	python -m pytest tests/ -v --cov=etl_pipeline --cov-report=term-missing --cov-report=html
	@echo "✓ Coverage report generated in htmlcov/\n"

# =============================================================================
# Cleanup
# =============================================================================
clean:
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	@echo "▶ Cleaning up cache files"
	@echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".ruff_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "htmlcov" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	rm -rf build/ dist/ 2>/dev/null || true
	@echo "✓ Cleanup complete\n"
